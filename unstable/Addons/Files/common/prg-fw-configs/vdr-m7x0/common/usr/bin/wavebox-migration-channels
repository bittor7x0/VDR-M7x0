#!/bin/ash
# (c) Andreas Koch & Lemmi, open7x0.org, 2007-01-13


AWKPROG='
   function hextonum(s,   t1, t2, i, z) {
      t1=0
      z["A"] = 10
      z["B"] = 11
      z["C"] = 12
      z["D"] = 13
      z["E"] = 14
      z["F"] = 15
      for(i = 1 ; i <= length(s) ; i++) {
        t1 *= 16
        t2 = z[substr(s,i,1)]
        t2 = t2 == "" ? substr(s,i,1) : t2
        t1 += t2
      }
      return t1
   }
   BEGIN { FS = " |:"; RADIO = ""; print ":TV" }
   ARGIND == 1 { 
      channel_long_name = $1
      for (i=2 ; $i != "0"; i++) 
         if ($i!="" && $i!=" ") 
            channel_long_name = channel_long_name " " $i 
      for (i++ ; length($i) < 5 ;i++)
         ;
      channel_no = substr($i,3,2)
      if (channel_no < 21)   
         channel_freq = 7000000 * channel_no + 142500000
      else   
         channel_freq = 8000000 * channel_no + 306000000
      for (i++ ; length($i) < 4 ; i++)
         ;
      channel_vpid = $i != "1FFF" ? hextonum($i): 0
      channel_apid = $(i+1) != "1FFF" ? hextonum($(i+1)) "=esl" : 0
      channel_tpid = $(i+4) != "1FFF" ? hextonum($(i+4)): 0
      channel_ac3pid = $(i+6) != "1FFF" ? ";" hextonum($(i+6)) "=esl" : ""
      channel_short_name = substr($(i+7),7,3)
      channel_short_name = channel_short_name != "" ? "," channel_short_name : ""
      
      for (i += 8 ; length($i) < 4 ; i++)
         ;
      channel_tid = hextonum($i)
      channel_sid = hextonum($(i+1))
      channel_nid = hextonum($(i+2))
      channel_data[$NF]= channel_long_name channel_short_name \
         ":" channel_freq \
         ":I999B999C999D999M999T999G999Y999:T:27500:" channel_vpid \
         ":" channel_apid channel_ac3pid ":" channel_tpid ":0:" \
         channel_sid ":" channel_nid ":" channel_tid ":0" 
   } 
   ARGIND == 2 && $2 != "" && channel_data[$2] != "" {
      if ( $2 < 20000 )
	print channel_data[$2]
      else
	RADIO = RADIO channel_data[$2] "\n"
      channel_data[$2] = ""
   }
   END { if ( RADIO != "" ) printf(":Radio\n%s",RADIO); }
'

source /etc/rc.local.conf

if [ -f /rescue/var/etc/services.txt ] && [ -f /rescue/var/etc/user_services.txt ] ; then
	awk "$AWKPROG" /rescue/var/etc/services.txt /rescue/var/etc/user_services.txt > ${vdr_confdir}/channels.conf
fi